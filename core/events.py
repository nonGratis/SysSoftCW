"""
Модуль визначення типів подій та базових структур даних системи.

Цей модуль містить визначення всіх типів подій, що виникають під час роботи
операційної системи, а також структури даних для запитів введення-виведення
та подій дискретного моделювання. Модуль забезпечує типізацію даних для
безпечної роботи з компонентами системи.

Автор: Студент
Курсова робота: Алгоритми планування введення-виведення для жорсткого диска
"""

from dataclasses import dataclass
from enum import Enum
from typing import Dict, Any


class RequestType(Enum):
    """
    Перелік типів запитів введення-виведення до жорсткого диска.
    
    Значення:
        READ: Запит на читання даних із сектора диска у буферний кеш
        WRITE: Запит на запис даних із буферного кешу до сектора диска
    """
    READ = "READ"
    WRITE = "WRITE"


class EventType(Enum):
    """
    Перелік типів подій у системі дискретного подійного моделювання.
    
    Події класифіковано за категоріями для зручності розуміння логіки системи.
    Кожна подія відповідає конкретному етапу життєвого циклу процесу або
    операції введення-виведення.
    
    Події процесів користувача:
        PROCESS_START: Початок виконання процесу після отримання кванта часу
                       від планувальника процесів операційної системи
        PROCESS_COMPUTE: Процес виконує обробку даних у режимі користувача
                        після завершення операції введення-виведення
        PROCESS_END: Завершення виконання всіх операцій процесу та його
                    видалення зі списку активних процесів
        QUANTUM_END: Закінчення кванта часу для поточного процесу, що призводить
                    до його переміщення в кінець черги готових процесів
    
    Події системних викликів:
        SYSCALL_START: Початок виконання системного виклику read або write,
                      що включає перехід з режиму користувача до режиму ядра
        SYSCALL_END: Завершення системного виклику та прийняття рішення про
                    подальші дії процесу залежно від стану буферного кешу
    
    Події операцій жорсткого диска:
        DISK_SEEK_END: Завершення переміщення магнітної головки читання-запису
                      до потрібної доріжки на поверхні диска
        DISK_ROTATION_END: Завершення обертання пластини диска до моменту, коли
                          потрібний сектор опиниться під магнітною головкою
        DISK_TRANSFER_END: Завершення передачі даних між контролером диска
                          та оперативною пам'яттю засобами прямого доступу
    
    Події апаратних переривань:
        INTERRUPT_START: Початок обробки апаратного переривання від контролера
                        жорсткого диска про завершення операції введення-виведення
        INTERRUPT_END: Завершення обробки переривання, розблокування процесу
                      та можливий запуск наступної операції введення-виведення
    """
    PROCESS_START = "PROCESS_START"
    PROCESS_COMPUTE = "PROCESS_COMPUTE"
    PROCESS_END = "PROCESS_END"
    QUANTUM_END = "QUANTUM_END"
    
    SYSCALL_START = "SYSCALL_START"
    SYSCALL_END = "SYSCALL_END"
    
    DISK_SEEK_END = "DISK_SEEK_END"
    DISK_ROTATION_END = "DISK_ROTATION_END"
    DISK_TRANSFER_END = "DISK_TRANSFER_END"
    
    INTERRUPT_START = "INTERRUPT_START"
    INTERRUPT_END = "INTERRUPT_END"


@dataclass
class IORequest:
    """
    Структура даних для представлення запиту введення-виведення до диска.
    
    Запит містить всю необхідну інформацію для виконання операції читання
    або запису сектора жорсткого диска. Драйвер пристрою використовує цю
    структуру для передачі запитів від ядра операційної системи до
    планувальника введення-виведення.
    
    Атрибути:
        sector: Номер логічного блоку або сектора на жорсткому диску для
               виконання операції читання або запису даних
        request_type: Тип операції, що вказує на характер звернення до диска
                     (читання існуючих даних або запис нових даних)
        process_id: Унікальний ідентифікатор процесу, що ініціював запит
                   через виклик системної функції read або write
        arrival_time: Час надходження запиту до планувальника введення-виведення
                     у мілісекундах від початку симуляції системи
    """
    sector: int
    request_type: RequestType
    process_id: int
    arrival_time: float
    
    def get_track(self, sectors_per_track: int) -> int:
        """
        Визначає номер циліндричної доріжки для заданого логічного сектора.
        
        Метод виконує перетворення логічної адресації блоків у фізичну
        адресацію, визначаючи на якій доріжці магнітного диска розташовано
        потрібний сектор. Це перетворення необхідне для розрахунку часу
        позиціювання механізму приводу головки читання-запису.
        
        Args:
            sectors_per_track: Кількість секторів на одній циліндричній доріжці
                              диска, що є сталою величиною для конкретної моделі
        
        Returns:
            Номер доріжки від нуля до максимальної кількості доріжок мінус один,
            на якій розташований заданий сектор відповідно до схеми адресації
        """
        return self.sector // sectors_per_track


@dataclass
class Event:
    """
    Структура даних для події в системі дискретного подійного моделювання.
    
    Події є основою роботи симулятора та представляють собою елементарні
    зміни стану системи у конкретний момент віртуального часу. Черга подій
    з пріоритетами забезпечує коректний порядок обробки всіх змін стану
    системи від початку до завершення симуляції.
    
    Атрибути:
        time: Час виникнення події у мілісекундах від початку симуляції,
             що визначає момент обробки події в системі подійного моделювання
        event_type: Тип події з переліку EventType, що визначає обробник
                   для виконання відповідних дій при настанні події
        data: Словник із додатковими даними, специфічними для конкретного
             типу події, такими як посилання на процес або параметри запиту
    """
    time: float
    event_type: EventType
    data: Dict[str, Any]
    
    def __lt__(self, other):
        """
        Оператор порівняння для підтримки черги з пріоритетами подій.
        
        Метод забезпечує можливість використання структури Event у черзі
        з пріоритетами модуля heapq стандартної бібліотеки Python. Події
        порівнюються виключно за часом їх виникнення для гарантування
        коректної хронологічної послідовності обробки подій симулятором.
        
        У разі однакового часу виникнення двох подій порядок їх обробки
        визначається стандартною логікою Python та не впливає на коректність
        роботи симулятора, оскільки події з однаковим часом є незалежними.
        
        Args:
            other: Інший об'єкт події для порівняння з поточним об'єктом
        
        Returns:
            Булеве значення True якщо поточна подія має менший час виникнення
            порівняно з іншою подією, що означає вищий пріоритет в черзі
        """
        return self.time < other.time


class Buffer:
    """
    Представлення буфера у буферному кеші операційної системи.
    
    Буфер є основною одиницею зберігання даних у буферному кеші ядра
    операційної системи. Кожен буфер містить копію даних одного сектора
    жорсткого диска в оперативній пам'яті для прискорення доступу до
    часто використовуваних даних без необхідності звернення до диска.
    
    Атрибути:
        sector: Номер сектора жорсткого диска, копію даних якого зберігає
               буфер в оперативній пам'яті системи
        dirty: Прапорець модифікації даних буфера, що вказує чи були дані
              змінені в оперативній пам'яті порівняно з даними на диску
        counter: Лічильник звернень до буфера, що може використовуватись
                деякими алгоритмами управління кешем для прийняття рішень
                про витіснення буферів при нестачі вільного місця
    """
    def __init__(self, sector: int):
        """
        Ініціалізує новий буфер для зберігання даних заданого сектора.
        
        Створює буфер у стані без модифікацій з нульовим лічильником звернень,
        що відповідає буферу одразу після завантаження даних з диска перед
        першим використанням процесом користувача.
        
        Args:
            sector: Номер сектора жорсткого диска для збереження в буфері
        """
        self.sector = sector
        self.dirty = False
        self.counter = 0
    
    def __repr__(self):
        """
        Повертає текстове представлення буфера для цілей налагодження.
        
        Метод формує зрозумілий рядок з інформацією про стан буфера,
        що включає номер сектора, прапорець модифікації та лічильник
        звернень для використання при виведенні діагностичної інформації.
        
        Returns:
            Рядок з форматованою інформацією про поточний стан буфера,
            що включає всі критичні атрибути об'єкта для аналізу роботи
        """
        status = "dirty" if self.dirty else "clean"
        return f"Buffer(sector={self.sector}, {status}, counter={self.counter})"

